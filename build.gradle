/*
 * This file was generated by the Gradle 'init' task.
 *
 * This is a general purpose Gradle build.
 * Learn more about Gradle by exploring our samples at https://docs.gradle.org/7.2/samples
 */
plugins{
    id "org.unbroken-dome.gitversion" version "0.10.0"
}

gitVersion{
    rules{
        //baseVersion = "1.0.0"

        onBranch('develop'){
            def lastTag = findLatestTag ~/v?(\d+)\.(\d+)/, true

            if(lastTag){
                def commits =  countCommitsSince lastTag
                version.mayor = lastTag.mayor
                version.minor = lastTag.minor+1
                version.patch = 0
                version.prereleaseTag = "alpha.$commits"
            }
            else {
                def commits =  countCommitsSince branchPoint('master')
                version.prereleaseTag = "alpha.$commits"
            }
        }

        onBranch(~/feature\/(.+)/) {
            def lastTag = findLatestTag ~/v?\d+\.\d+.\d+-\D+\.(\d+)/
            int commitsFromLastTag
            int commitsFromDevelop = countCommitsSince branchPoint('develop');

            if(lastTag){
                version.mayor = lastTag.mayor
                version.minor = lastTag.minor
                version.patch = lastTag.patch
                commitsFromLastTag = lastTag.matches[1]
            } else {
                commitsFromLastTag = 0
            }

            version.prereleaseTag = "${matches[1]}.$commitsFromLastTag+$commitsFromDevelop"
        }
    }
}

task show{
    doLast {
        println gitVersion.determineVersion()
    }
}